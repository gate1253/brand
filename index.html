<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>GATE1253</title>
	<link rel="stylesheet" href="assets/style.css" />
</head>
<body>
	<!-- 추가: 우측 상단 고정 Support 링크 -->
	<a class="top-right-support" href="/support/" title="지원 페이지 열기" aria-label="지원 페이지">Support</a>
	<!-- 추가: 우측 상단 Intro MP4 링크 -->
	<a class="top-right-intro" href="/support/intro.mp4" title="소개 영상 열기" aria-label="소개 영상">Intro</a>
	<!-- 추가: 우측 상단 presentation.pdf 링크 -->
	<a class="top-right-doc" href="/support/presentation.pdf" target="_blank" rel="noopener noreferrer" title="프레젠테이션 PDF 열기" aria-label="프레젠테이션 PDF">Presentation</a>
	<!-- 변경: 로그인/로그아웃 버튼을 위한 동적 컨테이너에 스타일 클래스 추가 -->
	<div id="auth-container" class="auth-widget"></div>

	<main class="container" role="main">
		<!-- 중앙 정렬된 로고 + 간단 설명 -->
		<div class="brand" role="banner">
			<img id="logo-img" class="logo" src="assets/images/logo-r3.jpg" alt="R3">
			<div class="service-toggle" style="margin-bottom: 16px; display: flex; gap: 8px;">
				<a id="r1-btn" class="service-toggle-btn hidden" href="#" title="R1" aria-label="R1">R1</a>
				<a id="r2-btn" class="service-toggle-btn hidden" href="#" title="R2" aria-label="R2">R2</a>
				<a id="r5-btn" class="service-toggle-btn hidden" href="#" title="R5" aria-label="R5">R5</a>
				<a id="r3-btn" class="service-toggle-btn active" href="#" title="R3" aria-label="R3">R3</a>
			</div>
			<p id="lead-text" class="lead" style="margin-top:0">간단하고 빠른 단축 URL 생성 서비스</p>
		</div>

		<!-- 중앙 검색(단축) 박스 -->
		<section aria-labelledby="shorten-heading">
			<h2 id="shorten-heading" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">단축 URL 생성</h2>
			<!-- 입력 필드들을 감싸는 부모 컨테이너 추가 -->
			<div id="search-wrap" class="search-wrap">
				<form class="search-box" onsubmit="event.preventDefault(); document.getElementById('shorten-btn').click();">
					<input id="url-input" type="url" placeholder="원본 URL을 입력하세요 (예: https://example.com)" aria-label="원본 URL" />
					<button id="shorten-btn" type="button">CREATE</button>
				</form>
	
				<!-- 추가: 로그인 시 커스텀 코드 입력 필드 -->
				<div id="alias-input-container" class="search-box alias-box hidden">
					<input id="alias-input" type="text" placeholder="커스텀 코드 (선택 사항)" aria-label="커스텀 코드" style="flex:1;border:none;outline:none;padding:8px;background:transparent;">
				</div>

				<!-- R1 전용: 만료일 설정 필드 -->
				<div id="expiration-input-container" class="search-box alias-box hidden">
					<input id="expiration-input" type="text" placeholder="만료일" aria-label="만료일" style="flex:1;border:none;outline:none;padding:8px;background:transparent;font-size:16px;color:#333;">
					<label style="display:flex; align-items:center; gap:5px; font-size: 14px; color: #555; cursor: pointer; white-space: nowrap;">
						<input type="checkbox" id="utc-checkbox"> UTC
					</label>
				</div>
			</div>
			<!-- 결과는 입력폼 영역이 대체하여 표시됩니다 (result-box 삭제) -->
			<p id="custom-code-note" class="note" style="text-align:center;margin:8px 0 0">비회원은 커스텀 코드를 제공할 수 없습니다. 커스텀 코드가 필요하면 회원으로 로그인하세요.</p>
			<div id="msg" class="status" role="status" aria-live="polite" style="text-align:center"></div>
		</section>
	</main>

	<!-- 추가: API 키 모달 -->
	<div id="api-key-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<button class="modal-close-btn" id="modal-close-btn">&times;</button>
			<h2>내 계정 정보</h2>
			<p>아래 정보를 사용하여 API를 호출하거나 계정을 식별할 수 있습니다.</p>

			<div class="api-key-section">
				<h3>API 키</h3>
				<div class="api-key-display">
					<code id="display-api-key"></code>
					<button id="copy-api-key-btn" class="btn primary small">COPY</button>
				</div>
			</div>

			<div class="user-id-section">
				<h3>고유 사용자 ID</h3>
				<div class="api-key-display">
					<code id="display-unique-user-id"></code>
					<button id="copy-user-id-btn" class="btn primary small">COPY</button>
				</div>
			</div>
			
			<p class="modal-message" id="modal-message"></p>
		</div>
	</div>

	<!-- 추가: 비디오 모달 -->
	<div id="video-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<button class="close-button" id="close-video-modal">&times;</button>
			<div id="video-container"></div>
		</div>
	</div>

	<script src="/member/auth.js" defer></script>
	<script src="assets/app.js" defer></script>
	<script src="assets/script.js" defer></script>
	<script>
		// 추가: 로그인 상태에 따라 UI를 동적으로 변경하는 스크립트
		// auth.js에서 사용자 정보를 로드한 후 이 함수를 호출합니다.
		function updateUIForUser(user) {
			const authContainer = document.getElementById('auth-container'); // 이 함수 내에서만 사용
			const r1Btn = document.getElementById('r1-btn'); // 아래 DOMContentLoaded에서 다시 선언됨
			const r2Btn = document.getElementById('r2-btn'); // 아래 DOMContentLoaded에서 다시 선언됨
			const r5Btn = document.getElementById('r5-btn'); // 아래 DOMContentLoaded에서 다시 선언됨

			// 로그인 상태에 따라 커스텀 입력 필드 표시/숨김
			const aliasInputContainer = document.getElementById('alias-input-container');
			const expirationInputContainer = document.getElementById('expiration-input-container');
			const customCodeNote = document.getElementById('custom-code-note');

			if (user) {
				r1Btn.classList.remove('hidden');
				r2Btn.classList.remove('hidden');
				r5Btn.classList.remove('hidden');
				// 로그인된 경우: 프로필 사진과 로그아웃 버튼 표시
				const userName = user.name || 'User profile';
				authContainer.innerHTML = `
					${user.picture ? `<img src="${user.picture}" alt="${userName}" class="profile-picture clickable" id="profile-picture">` : ''}
					<button id="logout-btn" class="auth-button" type="button">Logout</button>
				`;
				document.getElementById('logout-btn').addEventListener('click', () => {
					window.logout();
				});

				// 로그인 시, 활성화된 버튼에 따라 적절한 입력창 표시
				if (r1Btn.classList.contains('active')) {
					expirationInputContainer.classList.remove('hidden');
					aliasInputContainer.classList.add('hidden');
				} else {
					aliasInputContainer.classList.remove('hidden');
					expirationInputContainer.classList.add('hidden');
				}
				customCodeNote.style.display = 'none';

				// 프로필 사진 클릭 시 API 키 모달 열기
				const profilePicture = document.getElementById('profile-picture');
				if (profilePicture) {
					profilePicture.addEventListener('click', () => {
						const apiKeyModal = document.getElementById('api-key-modal');
						const displayApiKey = document.getElementById('display-api-key');
						const displayUniqueUserId = document.getElementById('display-unique-user-id'); // 추가
						const modalMessage = document.getElementById('modal-message');
						
						displayApiKey.textContent = user.apiKey;
						displayUniqueUserId.textContent = user.uniqueUserId; // 추가
						modalMessage.textContent = ''; // 이전 메시지 초기화
						apiKeyModal.classList.remove('hidden');
					});
				}
			} else {
				// 로그아웃된 경우: 로그인 버튼 표시
				authContainer.innerHTML = `<a class="auth-button" href="/member/login.html">Login</a>`;
				// 로그아웃 시 커스텀 코드 입력창 숨김
				aliasInputContainer.classList.add('hidden');
				expirationInputContainer.classList.add('hidden');
				customCodeNote.style.display = 'block';
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			// 모든 버튼과 UI 요소를 여기서 한 번만 선언합니다.
			const r1Btn = document.getElementById('r1-btn');
			const r2Btn = document.getElementById('r2-btn');
			const r3Btn = document.getElementById('r3-btn');
			const r5Btn = document.getElementById('r5-btn');
			const aliasInputContainer = document.getElementById('alias-input-container');
			const expirationInputContainer = document.getElementById('expiration-input-container');
			const logoImg = document.getElementById('logo-img');
			const leadText = document.getElementById('lead-text');
			const urlParams = new URLSearchParams(window.location.search);
			let user;

			if (urlParams.get('testuser') === '1') {
				// 테스트용 임시 사용자 정보 (URL에 ?testuser=1 추가 시 활성화)
				user = {
					name: 'Test User',
					picture: 'https://lh3.googleusercontent.com/a/default-user=s96-c',
					apiKey: 'test-api-key-for-viewing-123',
					uniqueUserId: 'test-user-id-for-viewing-456'
				};
			} else {
				// 페이지 로드 시 localStorage에서 실제 사용자 정보를 가져옵니다.
				user = window.getCurrentUser();
			}

			window.user = user; // 다른 스크립트(app.js 등)에서 참조할 수 있도록 전역 변수에 할당
			updateUIForUser(user);


			// 모달 닫기 버튼 이벤트
			document.getElementById('modal-close-btn').addEventListener('click', () => {
				document.getElementById('api-key-modal').classList.add('hidden');
			});

			// API 키 복사 버튼 이벤트
			document.getElementById('copy-api-key-btn').addEventListener('click', async () => {
				const apiKey = document.getElementById('display-api-key').textContent;
				const modalMessage = document.getElementById('modal-message');
				try {
					await navigator.clipboard.writeText(apiKey);
					modalMessage.textContent = 'API 키가 클립보드에 복사되었습니다.';
				} catch (err) {
					modalMessage.textContent = 'API 키 복사 실패.';
					console.error('Failed to copy API key:', err);
				}
			});

			// 고유 사용자 ID 복사 버튼 이벤트 추가
			document.getElementById('copy-user-id-btn').addEventListener('click', async () => {
				const uniqueUserId = document.getElementById('display-unique-user-id').textContent;
				const modalMessage = document.getElementById('modal-message');
				try {
					await navigator.clipboard.writeText(uniqueUserId);
					modalMessage.textContent = '고유 사용자 ID가 클립보드에 복사되었습니다.';
				} catch (err) {
					modalMessage.textContent = '고유 사용자 ID 복사 실패.';
					console.error('Failed to copy Unique User ID:', err);
				}
			});

			// R3 버튼 클릭 핸들러
			r3Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!r3Btn.classList.contains('active')) {
					// 모든 버튼 비활성화 후 현재 버튼만 활성화
					[r1Btn, r2Btn, r3Btn, r5Btn].forEach(btn => btn.classList.remove('active'));
					r3Btn.classList.add('active');
					logoImg.src = 'assets/images/logo-r3.jpg';
					logoImg.alt = 'R3';
					leadText.textContent = '간단하고 빠른 단축 URL 생성 서비스';
					if (user) {
						aliasInputContainer.classList.remove('hidden');
						expirationInputContainer.classList.add('hidden');
					}
				}
			});

			// R2 버튼 클릭 핸들러
			r2Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!r2Btn.classList.contains('active')) {
					// 모든 버튼 비활성화 후 현재 버튼만 활성화
					[r1Btn, r2Btn, r3Btn, r5Btn].forEach(btn => btn.classList.remove('active'));
					r2Btn.classList.add('active');

					logoImg.src = 'assets/images/logo-r2.jpg';
					logoImg.alt = 'R2';
					leadText.textContent = '원본 URL 노출을 막아주는 안전한 단축 URL 서비스';
					if (user) {
						aliasInputContainer.classList.remove('hidden');
						expirationInputContainer.classList.add('hidden');
					}
				}
			});

			// R1 버튼 클릭 핸들러
			r1Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!r1Btn.classList.contains('active')) {
					// 모든 버튼 비활성화 후 현재 버튼만 활성화
					[r1Btn, r2Btn, r3Btn, r5Btn].forEach(btn => btn.classList.remove('active'));
					r1Btn.classList.add('active');

					// NOTE: 'logo-r1.jpg' 파일을 assets/images/ 폴더에 추가해야 합니다.
					logoImg.src = 'assets/images/logo-r1.jpg';
					logoImg.alt = 'R1';
					leadText.textContent = '간단하고 빠른 One Time URL 생성 서비스';
					if (user) {
						expirationInputContainer.classList.remove('hidden');
						aliasInputContainer.classList.add('hidden');
					}
				}
			});

			// R5 버튼 클릭 핸들러
			r5Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!r5Btn.classList.contains('active')) {
					// 모든 버튼 비활성화 후 현재 버튼만 활성화
					[r1Btn, r2Btn, r3Btn, r5Btn].forEach(btn => btn.classList.remove('active'));
					r5Btn.classList.add('active');

					// NOTE: 'logo-r5.jpg' 파일을 assets/images/ 폴더에 추가해야 합니다.
					logoImg.src = 'assets/images/logo-r5.jpg';
					logoImg.alt = 'R5';
					leadText.textContent = '대용량 파일 서비스에 적합한 단축 URL 생성 서비스';
					if (user) {
						aliasInputContainer.classList.remove('hidden');
						expirationInputContainer.classList.add('hidden');
					}
				}
			});

			// 추가: 비디오 모달 관련 스크립트
			const introLink = document.querySelector('.top-right-intro');
			const videoModal = document.getElementById('video-modal');
			const closeVideoModal = document.getElementById('close-video-modal');
			const videoContainer = document.getElementById('video-container');
			
			function openIntroVideo() {
				const videoUrl = introLink.getAttribute('href');
				videoContainer.innerHTML = `
					<video style="display: block; width: 100%; height: 100%;" controls autoplay playsinline muted>
						<source src="${videoUrl}" type="video/mp4">
						죄송합니다. 비디오를 재생할 수 없습니다.
					</video>
				`;
				videoModal.classList.remove('hidden');
			}

			introLink.addEventListener('click', function(event) {
				event.preventDefault();
				openIntroVideo();
			});

			if (!localStorage.getItem('hasSeenIntro')) {
				openIntroVideo();
				localStorage.setItem('hasSeenIntro', 'true');
			}

			closeVideoModal.addEventListener('click', function() {
				videoModal.classList.add('hidden');
				videoContainer.innerHTML = ''; // 비디오 정지
			});

			videoModal.addEventListener('click', function(e) {
				if (e.target === this) {
					this.classList.add('hidden');
					videoContainer.innerHTML = ''; // 비디오 정지
				}
			});

			// 추가: R1 만료일 입력 필드 placeholder 처리
			const expirationInput = document.getElementById('expiration-input');
			expirationInput.addEventListener('focus', function() {
				this.type = 'datetime-local';
				this.placeholder = '';
			});
			expirationInput.addEventListener('blur', function() {
				if (!this.value) {
					this.type = 'text';
					this.placeholder = '만료일';
				}
			});

			// 추가: R1 만료일이 변경될 때 UTC 변환 처리
			expirationInput.addEventListener('change', function() {
				const utcCheckbox = document.getElementById('utc-checkbox');
				if (this.value && !utcCheckbox.checked) {
					// 체크박스가 선택되지 않았고 값이 있으면, 입력된 로컬 시간을 UTC로 변환
					const localDate = new Date(this.value);
					// toISOString()은 항상 UTC 기준 ISO 8601 형식(YYYY-MM-DDTHH:mm:ss.sssZ)을 반환합니다.
					const utcString = localDate.toISOString();
					// app.js에서 이 값을 사용하도록 data-* 속성에 저장합니다.
					this.dataset.utcValue = utcString;
				} else {
					// 값이 없거나 UTC가 이미 체크된 경우, data-* 속성을 비웁니다.
					delete this.dataset.utcValue;
				}
			});
		});
	</script>
 </body>
 </html>
