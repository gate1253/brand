<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>RES302</title>
	<link rel="stylesheet" href="assets/style.css" />
</head>
<body>
	<!-- 추가: 우측 상단 고정 Support 링크 -->
	<a class="top-right-support" href="/support/" title="지원 페이지 열기" aria-label="지원 페이지">Support</a>
	<!-- 추가: 우측 상단 Intro MP4 링크 -->
	<a class="top-right-intro" href="/support/intro.mp4" title="소개 영상 열기" aria-label="소개 영상">Intro</a>
	<!-- 추가: 우측 상단 presentation.pdf 링크 -->
	<a class="top-right-doc" href="/support/presentation.pdf" target="_blank" rel="noopener noreferrer" title="프레젠테이션 PDF 열기" aria-label="프레젠테이션 PDF">Presentation</a>
	<!-- 변경: 로그인/로그아웃 버튼을 위한 동적 컨테이너에 스타일 클래스 추가 -->
	<div id="auth-container" class="auth-widget"></div>

	<main class="container" role="main">
		<!-- 중앙 정렬된 로고 + 간단 설명 -->
		<div class="brand" role="banner">
			<img id="logo-img" class="logo" src="assets/images/logo-r3.jpg" alt="R3">
			<div class="service-toggle" style="margin-bottom: 16px; display: flex; gap: 8px;">
				<a id="res302-btn" class="service-toggle-btn active" href="#" title="RES302" aria-label="RES302">RES302</a>
				<a id="res200-btn" class="service-toggle-btn hidden" href="#" title="RES200" aria-label="RES200">RES200</a>
			</div>
			<p class="lead" style="margin-top:0">간단하고 빠른 단축 URL 생성 서비스</p>
		</div>

		<!-- 중앙 검색(단축) 박스 -->
		<section aria-labelledby="shorten-heading">
			<h2 id="shorten-heading" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">단축 URL 생성</h2>
			<form class="search-box" onsubmit="event.preventDefault(); document.getElementById('shorten-btn').click();">
				<input id="url-input" type="url" placeholder="원본 URL을 입력하세요 (예: https://example.com)" aria-label="원본 URL" />
				<button id="shorten-btn" type="button">CREATE</button>
			</form>

			<!-- 추가: 로그인 시 커스텀 코드 입력 필드 -->
			<div id="alias-input-container" class="search-box alias-box hidden">
				<input id="alias-input" type="text" placeholder="커스텀 코드 (선택 사항)" aria-label="커스텀 코드" style="flex:1;border:none;outline:none;padding:8px;background:transparent;">
			</div>

			<!-- 결과는 입력폼 영역이 대체하여 표시됩니다 (result-box 삭제) -->
			<p id="custom-code-note" class="note" style="text-align:center;margin:8px 0 0">비회원은 커스텀 코드를 제공할 수 없습니다. 커스텀 코드가 필요하면 회원으로 로그인하세요.</p>
			<div id="msg" class="status" role="status" aria-live="polite" style="text-align:center"></div>
		</section>
	</main>

	<!-- 추가: API 키 모달 -->
	<div id="api-key-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<button class="modal-close-btn" id="modal-close-btn">&times;</button>
			<h2>내 계정 정보</h2>
			<p>아래 정보를 사용하여 API를 호출하거나 계정을 식별할 수 있습니다.</p>

			<div class="api-key-section">
				<h3>API 키</h3>
				<div class="api-key-display">
					<code id="display-api-key"></code>
					<button id="copy-api-key-btn" class="btn primary small">COPY</button>
				</div>
			</div>

			<div class="user-id-section">
				<h3>고유 사용자 ID</h3>
				<div class="api-key-display">
					<code id="display-unique-user-id"></code>
					<button id="copy-user-id-btn" class="btn primary small">COPY</button>
				</div>
			</div>
			
			<p class="modal-message" id="modal-message"></p>
		</div>
	</div>

	<!-- 추가: 비디오 모달 -->
	<div id="video-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<button class="close-button" id="close-video-modal">&times;</button>
			<div id="video-container"></div>
		</div>
	</div>

	<script src="/member/auth.js" defer></script>
	<script src="assets/app.js" defer></script>
	<script src="assets/script.js" defer></script>
	<script>
		// 추가: 로그인 상태에 따라 UI를 동적으로 변경하는 스크립트
		document.addEventListener('DOMContentLoaded', () => {
			const authContainer = document.getElementById('auth-container');
			const user = window.getCurrentUser();
			const res200Btn = document.getElementById('res200-btn');

			if (user) {
				res200Btn.classList.remove('hidden');
				// 로그인된 경우: 프로필 사진과 로그아웃 버튼 표시
				const userName = user.name || 'User profile';
				authContainer.innerHTML = `
					${user.picture ? `<img src="${user.picture}" alt="${userName}" class="profile-picture clickable" id="profile-picture">` : ''}
					<button id="logout-btn" class="auth-button" type="button">Logout</button>
				`;
				document.getElementById('logout-btn').addEventListener('click', () => {
					window.logout();
				});

				// 프로필 사진 클릭 시 API 키 모달 열기
				const profilePicture = document.getElementById('profile-picture');
				if (profilePicture) {
					profilePicture.addEventListener('click', () => {
						const apiKeyModal = document.getElementById('api-key-modal');
						const displayApiKey = document.getElementById('display-api-key');
						const displayUniqueUserId = document.getElementById('display-unique-user-id'); // 추가
						const modalMessage = document.getElementById('modal-message');
						
						displayApiKey.textContent = user.apiKey;
						displayUniqueUserId.textContent = user.uniqueUserId; // 추가
						modalMessage.textContent = ''; // 이전 메시지 초기화
						apiKeyModal.classList.remove('hidden');
					});
				}
			} else {
				// 로그아웃된 경우: 로그인 버튼 표시
				authContainer.innerHTML = `<a class="auth-button" href="/member/login.html">Login</a>`;
			}

			// 모달 닫기 버튼 이벤트
			document.getElementById('modal-close-btn').addEventListener('click', () => {
				document.getElementById('api-key-modal').classList.add('hidden');
			});

			// API 키 복사 버튼 이벤트
			document.getElementById('copy-api-key-btn').addEventListener('click', async () => {
				const apiKey = document.getElementById('display-api-key').textContent;
				const modalMessage = document.getElementById('modal-message');
				try {
					await navigator.clipboard.writeText(apiKey);
					modalMessage.textContent = 'API 키가 클립보드에 복사되었습니다.';
				} catch (err) {
					modalMessage.textContent = 'API 키 복사 실패.';
					console.error('Failed to copy API key:', err);
				}
			});

			// 고유 사용자 ID 복사 버튼 이벤트 추가
			document.getElementById('copy-user-id-btn').addEventListener('click', async () => {
				const uniqueUserId = document.getElementById('display-unique-user-id').textContent;
				const modalMessage = document.getElementById('modal-message');
				try {
					await navigator.clipboard.writeText(uniqueUserId);
					modalMessage.textContent = '고유 사용자 ID가 클립보드에 복사되었습니다.';
				} catch (err) {
					modalMessage.textContent = '고유 사용자 ID 복사 실패.';
					console.error('Failed to copy Unique User ID:', err);
				}
			});

			// 추가: RES302/RES200 토글 로직
			const res302Btn = document.getElementById('res302-btn');
			const logoImg = document.getElementById('logo-img');

			res302Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!res302Btn.classList.contains('active')) {
					res302Btn.classList.add('active');
					res200Btn.classList.remove('active');
					logoImg.src = 'assets/images/res302.png';
					logoImg.alt = 'RES302';
				}
			});

			res200Btn.addEventListener('click', (e) => {
				e.preventDefault();
				if (!res200Btn.classList.contains('active')) {
					res200Btn.classList.add('active');
					res302Btn.classList.remove('active');
					logoImg.src = 'assets/images/logo-r2.jpg';
					logoImg.alt = 'R2';
				}
			});

			// 추가: 단축 URL 생성 로직
			const shortenBtn = document.getElementById('shorten-btn');
			const urlInput = document.getElementById('url-input');
			const aliasInput = document.getElementById('alias-input');
			const aliasContainer = document.getElementById('alias-input-container');
			const customCodeNote = document.getElementById('custom-code-note');
			const msgDiv = document.getElementById('msg');
			const searchBox = document.querySelector('.search-box');

			// 로그인 상태에 따라 커스텀 입력 필드 표시
			if (window.getCurrentUser()) {
				aliasContainer.classList.remove('hidden');
				customCodeNote.style.display = 'none';
			}

			shortenBtn.addEventListener('click', async () => {
				const url = urlInput.value.trim();
				if (!url) {
					msgDiv.textContent = 'URL을 입력해주세요.';
					return;
				}

				const alias = aliasInput.value.trim();
				const user = window.getCurrentUser();

				if (alias && !user) {
					msgDiv.textContent = '커스텀 코드를 사용하려면 로그인이 필요합니다.';
					return;
				}

				msgDiv.textContent = '생성 중...';
				shortenBtn.disabled = true;

				try {
					const payload = { url };
					if (alias) payload.alias = alias;

					const headers = { 'Content-Type': 'application/json' };
					if (user && user.apiKey) {
						headers['Authorization'] = `Bearer ${user.apiKey}`;
					}

					const response = await fetch('/api/shorten', {
						method: 'POST',
						headers,
						body: JSON.stringify(payload)
					});

					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.error || '알 수 없는 오류가 발생했습니다.');
					}

					const isRes200Mode = res200Btn.classList.contains('active');
					const resultUrl = (isRes200Mode && data.shortUrl2) ? data.shortUrl2 : data.shortUrl;

					searchBox.style.display = 'none';
					aliasContainer.style.display = 'none';
					
					msgDiv.innerHTML = `
						<div class="result-box" style="text-align:center;">
							<p style="margin-bottom: 10px;">${data.message}</p>
							<div style="display: inline-flex; align-items: center; gap: 8px; background: #fff; padding: 4px 12px; border-radius: 8px; border: 1px solid #e0e0e0;">
								<a href="${resultUrl}" target="_blank" rel="noopener noreferrer">${resultUrl}</a>
								<button class="btn primary small" onclick="navigator.clipboard.writeText('${resultUrl}').then(() => this.textContent='복사됨!')">복사</button>
							</div>
							<br>
							<button class="btn secondary" style="margin-top: 15px;" onclick="window.location.reload()">새로 만들기</button>
						</div>
					`;

				} catch (error) {
					msgDiv.textContent = `오류: ${error.message}`;
				} finally {
					shortenBtn.disabled = false;
				}
			});

			// 추가: 비디오 모달 관련 스크립트
			const introLink = document.querySelector('.top-right-intro');
			const videoModal = document.getElementById('video-modal');
			const closeVideoModal = document.getElementById('close-video-modal');
			const videoContainer = document.getElementById('video-container');

			introLink.addEventListener('click', function(event) {
				event.preventDefault();
				const videoUrl = this.getAttribute('href');
				videoContainer.innerHTML = `
					<video style="display: block; width: 100%; height: 100%;" controls autoplay playsinline>
						<source src="${videoUrl}" type="video/mp4">
						죄송합니다. 비디오를 재생할 수 없습니다.
					</video>
				`;
				videoModal.classList.remove('hidden');
			});

			closeVideoModal.addEventListener('click', function() {
				videoModal.classList.add('hidden');
				videoContainer.innerHTML = ''; // 비디오 정지
			});

			videoModal.addEventListener('click', function(e) {
				if (e.target === this) {
					this.classList.add('hidden');
					videoContainer.innerHTML = ''; // 비디오 정지
				}
			});
		});
	</script>
 </body>
 </html>
