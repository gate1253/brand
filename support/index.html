<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GATE1253 · Support / API 사용 예제</title>
<link rel="stylesheet" href="/assets/style.css">
<style>
  body{font-family:Inter, Roboto, Arial, sans-serif;background:#f5f7fb;color:#222;margin:0;padding:24px}
  .wrap{max-width:900px;margin:24px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
  pre{background:#f7f9fc;padding:12px;border-radius:6px;overflow:auto;font-size:14px}
  .demo-section{margin-top:12px;padding:15px;border:1px solid #eef3fb;border-radius:8px;background:#fcfdff}
  .demo-inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
  .demo-inputs input{padding:10px;border:1px solid #e6eaf0;border-radius:6px;font-size:14px}
  .demo-actions{display:flex;gap:8px;align-items:center}
  .demo-actions button{padding:10px 14px;border:none;background:#1a73e8;color:#fff;border-radius:6px;cursor:pointer;font-weight:600}
  .demo-result{margin-top:12px;font-size:14px;color:#111;word-break:break-all}
  a.back{display:inline-block;margin-bottom:12px;color:#1a73e8;text-decoration:none}
</style>
</head>
<body>
  <div class="wrap" role="main">
    <a class="back" href="/" aria-label="홈으로 돌아가기">← 홈으로 돌아가기</a>
    <h1>API 사용 예제</h1>
    <p>단축 URL 생성 API 엔드포인트는 <code>POST /api/shorten</code> 입니다.</p>
    <p>로그인 사용자는 API 키를 <code>Authorization: Bearer &lt;YOUR_API_KEY&gt;</code> 헤더에 포함해야 합니다. </p>

    <h2>1) 로그인 사용자 예제 (r3 타입)</h2>
    <pre><code>curl -X POST "https://api.gate1253.workers.dev/api/shorten" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -d '{
    "url":"https://example.com/long/path/to/resource",
    "alias":"mycustomcode",
    "type": "r3"
  }'
</code></pre>
    <p>응답 예시 (커스텀 코드):</p>
    <pre><code>{
  "ok": true,
  "code": "YOUR_UNIQUE_USER_ID/mycustomcode",
  "shortUrl": "https://r3.ggm.kr/YOUR_UNIQUE_USER_ID/mycustomcode",
  "message": "단축 URL이 생성되었습니다."
}
</code></pre>

    <h2>1.1) 비회원 예제 (r3 타입)</h2>
    <pre><code>curl -X POST "https://api.gate1253.workers.dev/api/shorten" \
  -H "Content-Type: application/json" \
  -d '{
    "url":"https://example.com/another/long/path",
    "type": "r3"
  }'
</code></pre>
    <p>응답 예시 (무작위 코드):</p>
    <pre><code>{
  "ok": true,
  "code": "a1B2c3",
  "shortUrl": "https://r3.ggm.kr/a1B2c3",
  "message": "단축 URL이 생성되었습니다."
}
</code></pre>

    <h2>1.2) 로그인 사용자 예제 (R1 타입 - 만료 시간 지정)</h2>
    <pre><code>curl -X POST "https://api.gate1253.workers.dev/api/shorten" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -d '{
    "url":"https://example.com/secret-document",
    "type": "r1",
    "expiresAt": "2025-01-01T00:00:00Z"
  }'
</code></pre>
    <p>응답 예시 (R1 타입):</p>
    <pre><code>{
  "ok": true,
  "code": "YOUR_UNIQUE_USER_ID/a1B2c3",
  "shortUrl": "https://r1.ggm.kr/YOUR_UNIQUE_USER_ID/a1B2c3",
  "message": "단축 URL이 생성되었습니다."
}
</code></pre>

    <h2>2) JavaScript (fetch) 예제 (r2 타입)</h2>
    <pre><code>const API_BASE = 'https://api.gate1253.workers.dev';
const YOUR_API_KEY = 'YOUR_API_KEY_HERE'; // 실제 API 키로 교체

async function shortenWithCustomCode(originalUrl, customAlias) {
  const headers = { 'Content-Type': 'application/json' };
  if (YOUR_API_KEY) {
    headers['Authorization'] = `Bearer ${YOUR_API_KEY}`;
  }

  const body = {
    url: originalUrl,
    alias: customAlias,
    type: 'r2'
  };

  const res = await fetch(`${API_BASE}/api/shorten`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body)
  });
  return res.json();
}

// 사용 예:
shortenWithCustomCode('https://example.com/long/path/to/resource', 'my-secure-link')
  .then(data => console.log(data))
  .catch(err => console.error(err));
</code></pre>

    <h2>2.1) JavaScript (fetch) 예제 (r3 타입)</h2>
    <pre><code>const API_BASE = 'https://api.gate1253.workers.dev';

async function shortenAnonymous(originalUrl) {
  const headers = { 'Content-Type': 'application/json' };
  const body = { 
    url: originalUrl,
    type: 'r3' // 타입은 선택사항이며, 기본값은 'r3' 입니다.
  };

  const res = await fetch(`${API_BASE}/api/shorten`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body)
  });
  return res.json();
}

// 사용 예:
shortenAnonymous('https://example.com/another/long/path')
  .then(data => console.log(data))
  .catch(err => console.error(err));
</code></pre>
    <p>참고: 브라우저에서 다른 오리진으로 호출할 경우 CORS preflight(OPTIONS)가 발생합니다. 서비스는 기본적으로 모든 오리진을 허용하도록 설정되어 있지만, 필요 시 도메인 제한을 적용하세요.</p>

    <h2>2.2) JavaScript (fetch) 예제 (R1 타입 - 만료 시간 지정)</h2>
    <pre><code>const API_BASE = 'https://api.gate1253.workers.dev';
const YOUR_API_KEY = 'YOUR_API_KEY_HERE'; // 실제 API 키로 교체

async function shortenWithExpiration(originalUrl, expirationDateTime) {
  const headers = { 
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${YOUR_API_KEY}`
  };

  const body = { 
    url: originalUrl,
    type: 'r1',
    expiresAt: expirationDateTime // 예: "2025-01-01T00:00:00Z" (UTC 시간)
  };

  const res = await fetch(`${API_BASE}/api/shorten`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body)
  });
  return res.json();
}

// 사용 예:
shortenWithExpiration('https://example.com/secret-document', '2025-01-01T00:00:00')
  .then(data => console.log(data))
  .catch(err => console.error(err));
</code></pre>

    <h2>2.3) JavaScript (fetch) 예제 (R5 타입)</h2>
    <pre><code>const API_BASE = 'https://api.gate1253.workers.dev';

async function shortenForLargeFile(originalUrl) {
  const headers = { 'Content-Type': 'application/json' };
  const body = { url: originalUrl, type: 'r5' };

  const res = await fetch(`${API_BASE}/api/shorten`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body)
  });
  return res.json();
}
</code></pre>

    <h2>3) 페이지 내 데모</h2>
    <div class="demo-section">
      <div class="demo-inputs">
        <input id="demo-url" type="url" placeholder="원본 URL (예: https://example.com)" required />
        <input id="demo-api-key" type="text" placeholder="API Key (로그인 시 자동 입력)" />
        <div id="demo-type-selector" style="display: flex; gap: 15px; margin: 5px 0;">
          <label><input type="radio" name="demo-type" value="r1"> R1</label>
          <label><input type="radio" name="demo-type" value="r2"> R2</label>
          <label><input type="radio" name="demo-type" value="r3" checked> R3</label>
          <label><input type="radio" name="demo-type" value="r5"> R5</label>
        </div>
        <div id="demo-alias-container">
          <input id="demo-alias" type="text" placeholder="커스텀 코드 (선택 사항)" />
        </div>
        <div id="demo-expiration-container" class="hidden">
          <input id="demo-expiration" type="datetime-local" placeholder="만료일 (R1 전용)" />
          <label style="font-size: 12px; margin-left: 5px;">
            <input type="checkbox" id="demo-utc-checkbox"> UTC
          </label>
        </div>
      </div>
      <div class="demo-actions">
        <button id="demo-btn">단축 생성</button>
        <button id="demo-reset-btn" style="background:#f8f9fa;color:#202124;border:1px solid #dadce0;">초기화</button>
      </div>
      <div id="demo-result" class="demo-result" role="status"></div>
    </div>

    <script src="/member/auth.js" defer></script>
    <script>
      (function(){
        const API_BASE = 'https://api.gate1253.workers.dev';
        const btn = document.getElementById('demo-btn');
        const resetBtn = document.getElementById('demo-reset-btn');
        const urlInput = document.getElementById('demo-url');
        const apiKeyInput = document.getElementById('demo-api-key');
        const aliasInput = document.getElementById('demo-alias');
        const aliasContainer = document.getElementById('demo-alias-container');
        const expirationInput = document.getElementById('demo-expiration');
        const expirationContainer = document.getElementById('demo-expiration-container');
        const typeSelector = document.getElementById('demo-type-selector');
        const out = document.getElementById('demo-result');

        function resetDemo() {
          urlInput.value = '';
          apiKeyInput.value = '';
          aliasInput.value = '';
          expirationInput.value = '';
          document.querySelector('input[name="demo-type"][value="r3"]').checked = true;
          out.textContent = '';
          urlInput.focus();

          // 로그인 상태 확인 후 API 키 자동 채우기 (auth.js 로드 후 실행)
          const user = window.user || (window.getCurrentUser ? window.getCurrentUser() : null);
          if (user && user.apiKey) {
            apiKeyInput.value = user.apiKey;
          }
        }

        typeSelector.addEventListener('change', (e) => {
            if (e.target.value === 'r1') {
                aliasContainer.classList.add('hidden');
                expirationContainer.classList.remove('hidden');
            } else {
                aliasContainer.classList.remove('hidden');
                expirationContainer.classList.add('hidden');
            }
        });

        btn.addEventListener('click', async () => {
          const url = urlInput.value.trim();
          const apiKey = apiKeyInput.value.trim();
          const alias = aliasInput.value.trim();
          const type = document.querySelector('input[name="demo-type"]:checked').value;

          if(!url){ out.textContent = '원본 URL을 입력하세요.'; return; }
          out.textContent = '요청 중...';

          const headers = { 'Content-Type': 'application/json' };
          const requestBody = { url: url, type: type };

          if (apiKey) {
            headers['Authorization'] = `Bearer ${apiKey}`;
          }

          if (type === 'r1') {
            if (!apiKey) { out.textContent = 'R1 타입은 API Key가 필수입니다.'; return; }
            if (!expirationInput.value) { out.textContent = 'R1 타입은 만료일이 필수입니다.'; return; }
            
            const utcCheckbox = document.getElementById('demo-utc-checkbox');
            const localDate = new Date(expirationInput.value);
            if (utcCheckbox && utcCheckbox.checked) {
              // UTC 체크 시: 입력값을 UTC로 간주하고 ISO 문자열로 변환
              requestBody.expiresAt = new Date(localDate.getTime() - (localDate.getTimezoneOffset() * 60000)).toISOString();
            } else {
              // UTC 미체크 시: 입력값을 로컬 시간으로 간주하고 UTC로 변환
              requestBody.expiresAt = localDate.toISOString();
            }
          } else if (alias) {
            if (!apiKey) {
              out.textContent = '커스텀 코드 사용 시 API Key는 필수입니다.';
              return;
            }
            requestBody.alias = alias;
          }

          try{
            const res = await fetch(`${API_BASE}/api/shorten`, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify(requestBody)
            });
            const data = await res.json();
            if(!res.ok){
              out.textContent = data.error || '생성 실패';
              console.error('API Error:', data);
              return;
            }
            out.innerHTML = `완료: <a href="${data.shortUrl}" target="_blank" rel="noopener noreferrer">${data.shortUrl}</a> (메시지: ${data.message || '성공'})`;
          }catch(e){
            out.textContent = '요청 중 오류';
            console.error(e);
          }
        });

        resetBtn.addEventListener('click', resetDemo);

        // DOMContentLoaded 이후에 초기화 함수를 호출하여 auth.js가 먼저 실행되도록 보장
        document.addEventListener('DOMContentLoaded', () => {
          resetDemo();
        });

      })();
    </script>

    <h3>추가 안내</h3>
    <ul>
      <li>**로그인 사용자**: 커스텀 코드(alias)를 사용하려면 로그인하여 발급받은 API Key를 <code>Authorization: Bearer &lt;YOUR_API_KEY&gt;</code> 헤더에 포함해야 합니다. <code>uniqueUserId</code>는 API 키를 통해 워커에서 자동으로 검증됩니다.</li>
      <li>**비회원**: API Key와 커스텀 코드(alias)를 비워두면 무작위 단축 URL이 생성됩니다.</li>
      <li>대량 요청 시 rate limit이 적용될 수 있습니다. 자동화 전 관리자에게 문의하세요.</li>
    </ul>
  </div>
</body>
</html>
